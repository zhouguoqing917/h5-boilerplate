+function(t){"use strict";window.CustomEvent||(window.CustomEvent=function(t,e){var a=document.createEvent("CustomEvent");return a.initCustomEvent(t,e.bubbles,e.cancelable,e.detail,e.id),a});var e=function(){this.state=sessionStorage,this.state.setItem("stateid",parseInt(this.state.getItem("stateid")||1)+1),this.state.setItem("currentStateID",this.state.getItem("stateid")),this.stack=sessionStorage,this.stack.setItem("back","[]"),this.stack.setItem("forward","[]"),this.extras={},this.init(),this.xhr=null};e.prototype.defaults={transition:!0},e.prototype.init=function(){var e=this.getCurrentPage();e[0]||(e=t(".page").eq(0).addClass("page-current"));var a=location.hash;if(e[0]&&!e[0].id&&(e[0].id=a?a.slice(1):this.genRandomID()),!e[0])throw new Error("can't find .page element");var r=t(a);!r[0]||e[0]&&a.slice(1)===e[0].id||(e.removeClass("page-current"),r.addClass("page-current"),e=r);var s=history.state;if(!s){var n=this.genStateID();this.replaceState(location.href,n),this.setCurrentStateID(n)}var i=this;window.addEventListener("load",function(){setTimeout(function(){window.addEventListener("popstate",t.proxy(i.onpopstate,i))},0)},!1)},e.prototype.loadPage=function(e,a,r){var s=e;void 0===a&&(a=!this.defaults.transition),"string"==typeof e&&(s={url:e,noAnimation:a,replace:r});var e=s.url,a=s.noAnimation,r=s.replace;this.getPage(e,function(s,n){var i=this.getCurrentPage(),o=i[0].id;this[r?"replaceBack":"pushBack"]({url:location.href,pageid:"#"+o,id:this.getCurrentStateID(),animation:!a});for(var p=JSON.parse(this.state.getItem("forward")||"[]"),d=this,c=0;c<p.length;c++)t(p[c].pageid).each(function(){var e=t(this);if(e.data("page-remote")){var a=d.extras[e[0].id];a&&a.remove(),d.extras[e[0].id]=void 0,e.remove()}});this.state.setItem("forward","[]");var h=t("#"+t(s)[0].id);s.insertBefore(t(".page")[0]),h[0]!==s[0]&&h.remove(),n&&(d.extras[s[0].id]=n.appendTo(document.body));var u=this.genStateID();this.setCurrentStateID(u),this[r?"replaceState":"pushState"](e,u),this.forwardStack=[],this.animatePages(this.getCurrentPage(),s,null,a)})},e.prototype.replacePage=function(t,e){return this.loadPage(t,e,!0)},e.prototype.reloadPage=function(){return this.replacePage(location.href,!0)},e.prototype.animatePages=function(e,a,r,s){function n(t){t.removeClass(i),t.trigger("pageAnimationEnd",[t[0].id,t])}var i="page-left page-right page-from-center-to-left page-from-center-to-right page-from-right-to-center page-from-left-to-center";s?r?(e.trigger("pageAnimationStart",[a[0].id,a]),a.removeClass(i).removeClass("page-current"),e.removeClass(i).addClass("page-current"),e.hasClass("no-tabbar")?t(document.body).addClass("tabbar-hidden"):t(document.body).removeClass("tabbar-hidden"),a.trigger("pageInitInternal",[e[0].id,e])):(a.trigger("pageAnimationStart",[a[0].id,a]),e.removeClass(i).removeClass("page-current"),a.removeClass(i).addClass("page-current"),a.trigger("pageInitInternal",[a[0].id,a]),a.hasClass("no-tabbar")?t(document.body).addClass("tabbar-hidden"):t(document.body).removeClass("tabbar-hidden")):r?(e.trigger("pageAnimationStart",[a[0].id,a]),a.removeClass(i).addClass("page-from-center-to-right").removeClass("page-current"),e.removeClass(i).addClass("page-from-left-to-center page-current"),e.animationEnd(function(){n(e)}),a.animationEnd(function(){a.removeClass(i)}),e.hasClass("no-tabbar")?t(document.body).addClass("tabbar-hidden"):t(document.body).removeClass("tabbar-hidden"),a.trigger("pageInitInternal",[e[0].id,e])):(a.trigger("pageAnimationStart",[a[0].id,a]),e.removeClass(i).addClass("page-from-center-to-left").removeClass("page-current"),a.removeClass(i).addClass("page-from-right-to-center page-current"),e.animationEnd(function(){e.removeClass(i)}),a.animationEnd(function(){n(a)}),a.hasClass("no-tabbar")?t(document.body).addClass("tabbar-hidden"):t(document.body).removeClass("tabbar-hidden"),a.trigger("pageInitInternal",[a[0].id,a]))},e.prototype.getCurrentPage=function(){return t(".page-current")},e.prototype.forward=function(t){var e=JSON.parse(this.stack.getItem("forward"));e.length?history.forward():location.href=t},e.prototype.back=function(t){var e=JSON.parse(this.stack.getItem("back"));e.length?history.back():location.href=t},e.prototype._back=function(){var e=this.popBack();if(e){var a=this.getCurrentPage(),r=t(e.pageid);r[0]&&(this.pushForward({url:location.href,pageid:"#"+a[0].id,id:this.getCurrentStateID(),animation:e.animation}),this.setCurrentStateID(e.id),this.animatePages(r,a,!0,!e.animation))}},e.prototype._forward=function(){var e=this.popForward();if(e){var a=this.getCurrentPage(),r=t(e.pageid);r[0]&&(this.pushBack({url:location.href,pageid:"#"+a[0].id,id:this.getCurrentStateID(),animation:e.animation}),this.setCurrentStateID(e.id),this.animatePages(a,r,!1,!e.animation))}},e.prototype.pushState=function(t,e){history.pushState({url:t,id:e},"",t)},e.prototype.replaceState=function(t,e){history.replaceState({url:t,id:e},"",t)},e.prototype.onpopstate=function(t){console.log("popstate");var e=t.state;if(!e)return!0;if(e.id===this.getCurrentStateID())return!1;var a=e.id>this.getCurrentStateID();a?this._forward():this._back()},e.prototype.getPage=function(e,a){if("#"===e[0])return a.apply(this,[t(e)]);this.dispatch("pageLoadStart"),this.xhr&&this.xhr.readyState<4&&(this.xhr.onreadystatechange=t.noop,this.xhr.abort(),this.dispatch("pageLoadCancel"));var r=this;this.xhr=t.ajax({url:e,success:t.proxy(function(t,e,r){var s=this.parseXHR(r),n=s[0],i=s[1];n[0].id||(n[0].id=this.genRandomID()),n.data("page-remote",1),a.apply(this,[n,i])},this),error:function(){r.dispatch("pageLoadError")},complete:function(){r.dispatch("pageLoadComplete")}})},e.prototype.parseXHR=function(e){var a=e.responseText,r=a.match(/<body[^>]*>([\s\S.]*)<\/body>/i),s=r?r[1]:a;s="<div>"+s+"</div>";var n=t(s),i=n.find(".popup, .popover, .panel, .panel-overlay"),o=n.find(".page");return o[0]||(o=n.addClass("page")),[o,i]},e.prototype.genStateID=function(){var t=parseInt(this.state.getItem("stateid"))+1;return this.state.setItem("stateid",t),t},e.prototype.getCurrentStateID=function(){return parseInt(this.state.getItem("currentStateID"))},e.prototype.setCurrentStateID=function(t){this.state.setItem("currentStateID",t)},e.prototype.genRandomID=function(){return"page-"+ +new Date},e.prototype.popBack=function(){var t=JSON.parse(this.stack.getItem("back"));if(!t.length)return null;var e=t.splice(t.length-1,1)[0];return this.stack.setItem("back",JSON.stringify(t)),e},e.prototype.pushBack=function(t){var e=JSON.parse(this.stack.getItem("back"));e.push(t),this.stack.setItem("back",JSON.stringify(e))},e.prototype.replaceBack=function(t){var e=JSON.parse(this.stack.getItem("back"));e.pop(),e.push(t),this.stack.setItem("back",JSON.stringify(e))},e.prototype.popForward=function(){var t=JSON.parse(this.stack.getItem("forward"));if(!t.length)return null;var e=t.splice(t.length-1,1)[0];return this.stack.setItem("forward",JSON.stringify(t)),e},e.prototype.pushForward=function(t){var e=JSON.parse(this.stack.getItem("forward"));e.push(t),this.stack.setItem("forward",JSON.stringify(e))},e.prototype.dispatch=function(t){var e=new CustomEvent(t,{bubbles:!0,cancelable:!0});window.dispatchEvent(e)},t(function(){if(t.smConfig.router){var a=t.router=new e;a.defaults=e.prototype.defaults,t(document).on("click","a",function(e){var r=t(e.currentTarget);if(!(r.hasClass("external")||r[0].hasAttribute("external")||r.hasClass("tab-link")||r.hasClass("open-popup")||r.hasClass("open-panel"))){e.preventDefault();var s=r.attr("href");return r.hasClass("back")?void a.back(s):void(s&&"#"!==s&&a.loadPage(s,r.hasClass("no-transition")?!0:void 0,r.hasClass("replace")?!0:void 0))}})}})}($);